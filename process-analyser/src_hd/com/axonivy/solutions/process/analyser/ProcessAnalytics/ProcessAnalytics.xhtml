<html xmlns="http://www.w3.org/1999/xhtml"
  xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html"
  xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:ic="http://ivyteam.ch/jsf/component"
  xmlns:p="http://primefaces.org/ui"
  xmlns:pe="http://primefaces.org/ui/extensions">
<h:body>
  <ui:composition template="/layouts/frame-10-full-width.xhtml">
    <ui:define name="title">#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/Title')}</ui:define>
    <ui:define name="content">
      <h:outputScript name="resources/html2canvas.min.js" target="head"/>
        <h:outputStylesheet library="css" name="process-analyser.css" />

      <h:form id="process-analytics-form" styleClass="card">
        <p:remoteCommand id="update-data-table-cmd" name="updateDataTable"
          action="#{processesAnalyticsBean.updateDataTable}" update="data-statistics"
          process="@this" partialSubmit="true"/>
        <p:graphicImage id="hidden-image" library="ivy-cms"
          name="#{processesAnalyticsBean.miningUrl}" />
        <p:panelGrid columns="2" layout="grid" styleClass="ui-fluid"
          columnClasses="ui-g-6 pl-0, ui-g-6 pr-0 mr-0 grid align-items-center flex-row-reverse">
          <h:panelGroup layout="block"  styleClass="flex align-items-center h-full">
            <h3>#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessAnalytics/Title')}</h3>
          </h:panelGroup>

          <h:panelGroup>
            <p:commandButton id="show-statistic-btn"
                icon="pi pi-chart-line"
                value="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/ShowStatistic')}"
                styleClass="show-statistic-btn w-auto"
                update="process-analytics-form"
                actionListener="#{processesAnalyticsBean.updateDiagramAndStatistic}"
                disabled="#{processesAnalyticsBean.showStatisticBtnDisabled}" />

            <div class="grid mr-4 grid align-items-center line-height-4 mt-1">
              <p:outputLabel for="include-running-cases" value="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessAnalytics/IncludingRunningCases')}"
                styleClass="p-2" />
              <p:toggleSwitch id="include-running-cases" onIcon="pi pi-check" offIcon="pi pi-times"
                value="#{processesAnalyticsBean.includingRunningCases}">
                <p:ajax listener="#{processesAnalyticsBean.updateDiagramAndStatistic}" update="process-analytics-form"/>
              </p:toggleSwitch>
            </div>
          </h:panelGroup>
        </p:panelGrid>
        <p:outputPanel>
            <br />
        </p:outputPanel>

        <p:panelGrid id="search-fields" columns="3"
          styleClass="ui-fluid mb-3" layout="flex"
          columnClasses="ui-g-4, ui-g-4, ui-g-4">
          <h:panelGroup styleClass="ui-g field" layout="block">
            <p:outputLabel for="moduleDropdown"
              value="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/PleaseSelectProject')}" />
            <p:selectOneMenu id="moduleDropdown"
              value="#{processesAnalyticsBean.selectedModule}">
              <f:selectItem itemLabel="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/SelectProject')}" itemValue="#{null}"
                noSelectionOption="true" />
              <f:selectItems
                value="#{processesAnalyticsBean.availableModules}"
                var="module" itemLabel="#{module}" itemValue="#{module}" />
              <p:ajax event="change" partialSubmit="true" process="@this"
                listener="#{processesAnalyticsBean.onModuleSelect}" />
            </p:selectOneMenu>
          </h:panelGroup>

          <h:panelGroup id="process-selection-group" styleClass="ui-g field" layout="block">
            <p:outputLabel for="process-dropdown"
              value="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/PleaseSelectProcess')}" />
            <p:cascadeSelect id="process-dropdown" value="#{processesAnalyticsBean.selectedProcessAnalyser}"
              placeholder="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/SelectProcess')}"
              converter="processStartConverter" styleClass="w-full">
              <f:selectItems value="#{processesAnalyticsBean.availableProcessStarts}" />
              <p:ajax partialSubmit="true" process="@this" listener="#{processesAnalyticsBean.onProcessSelect}" />
            </p:cascadeSelect>
          </h:panelGroup>

          <h:panelGroup styleClass="ui-g field" layout="block">
            <p:outputLabel for="kpiDropdown"
              value="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/PleaseSelectKPI')}" />
            <p:cascadeSelect id="kpiDropdown" style="width: 100%"
              placeholder="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/SelectKPI')}"
              value="#{processesAnalyticsBean.selectedKpiType}" converter="kpiTypeConverter">
              <f:selectItems value="#{processesAnalyticsBean.kpiTypes}" />
              <p:ajax event="itemSelect"
                listener="#{processesAnalyticsBean.onKpiTypeSelect}" update="process-analytics-form:color-picker-component:color-container"
                process="@this" partialSubmit="true"/>
            </p:cascadeSelect>
          </h:panelGroup>
        </p:panelGrid>

        <h:panelGroup id="time-interval-group"
          styleClass="field col-12 grid formgrid align-items-start p-0 m-0 mb-3 field"
          layout="block">
          <ui:include src="TimeIntervalFilter.xhtml" />
          <p:remoteCommand id="filter-data-by-interval-rc"
            name="filterDataByIntervalRC"
            actionListener="#{processesAnalyticsBean.updateDataOnChangingFilter()}"
            process="@this" partialSubmit="true"/>
        </h:panelGroup>

        <hr />

        <ic:com.axonivy.solutions.process.analyser.component.CustomFilter
          id="custom-filter-panel-group"
          managedBean="#{processesAnalyticsBean}" />

        <ic:com.axonivy.solutions.process.analyser.component.ProcessViewer id="process-analytic-viewer-panel"
          process="#{processesAnalyticsBean.selectedProcessAnalyser}"
          componentsToUpdate="@this"/>

        <ic:com.axonivy.solutions.process.analyser.component.ColorPicker id="color-picker-component"
          kpiType="#{processesAnalyticsBean.selectedKpiType}"
          onColorChange="#{processesAnalyticsBean.refreshAnalyserReportToView()}"
          componentToUpdate="@this" />

        <hr />

        <h:panelGroup id="data-statistics" layout="block">
          <p:dataTable var="node" styleClass="grid" id="node"
            value="#{processesAnalyticsBean.filteredNodes}" scrollable="true"
            scrollHeight="300"
            emptyMessage="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/NoRecordsFound')}">
            <p:column styleClass="col-2" sortBy="#{node.id}"
              headerText="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/ElementId')}">
              <h:outputText value="#{node.id}" />
            </p:column>
            <p:column styleClass="col-2" sortable="true"
              sortBy="#{node.type.getCmsName()}"
              headerText="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/Type')}">
              <h:outputText value="#{node.type.getCmsName()}" />
            </p:column>
            <p:column styleClass="col-4" sortBy="#{node.label}"
              headerText="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/Label')}">
              <h:outputText value="#{node.label}" />
            </p:column>
            <p:column
              rendered="#{'FREQUENCY' == processesAnalyticsBean.selectedKpiType}"
              styleClass="col-2" sortBy="#{node.frequency}"
              exportValue="#{node.frequency}"
              headerText="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/Frequency')}">
              <h:panelGroup layout="block" styleClass="colorable-cell"
                style="background-color: #{processesAnalyticsBean.getCalulatedCellColor(node.relativeValue)};
                  color: #{processesAnalyticsBean.getAccessibleTextColor(node.relativeValue)};">
                <h:outputText value="#{node.frequency}" />
              </h:panelGroup>
            </p:column>
            <p:column
              rendered="#{processesAnalyticsBean.isMedianDurationColumnVisible()}"
              styleClass="col-2" sortBy="#{node.medianDuration}"
              exportValue="#{node.formattedMedianDuration}"
              headerText="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/MedianDuration')}">
              <h:panelGroup layout="block" styleClass="colorable-cell"
                style="background-color: #{processesAnalyticsBean.getCalulatedCellColor(node.relativeValue)};
                  color: #{processesAnalyticsBean.getAccessibleTextColor(node.relativeValue)};">
                <h:outputText value="#{node.formattedMedianDuration}" />
              </h:panelGroup>
            </p:column>
            <f:facet name="footer">
              <h:outputText
                value="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/TotalElements', [processesAnalyticsBean.filteredNodes.size()])}"
                styleClass="col-12" />
            </f:facet>
          </p:dataTable>
          <br />
        </h:panelGroup>
        <h:panelGroup
          id="action-btn-group"
          styleClass="col-12 p-0 inline-flex justify-content-end"
          layout="block">
          <p:menuButton icon="pi pi-upload" styleClass="action-button mr-3"
            value="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessAnalytics/ExportJPEG')}">
            <p:menuitem value="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessAnalytics/CaptureEntireScreen')}"
              actionListener="#{processesAnalyticsBean.prepareForExportingJPEG(true)}"
              process="@this" partialSubmit="true"
              update="action-btn-group process-analytics-form:process-analytic-viewer-panel:viewer-group" icon="pi pi-desktop"
              oncomplete="getFullDiagramData(); return true;" />
            <p:menuitem value="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessAnalytics/CaptureCurrentView')}"
              process="@this" partialSubmit="true"
              update="action-btn-group" icon="pi pi-th-large"
              oncomplete="getCurrentViewPortOfDiagramData(); return true;" />
          </p:menuButton>
          <p:commandButton icon="pi pi-upload" styleClass="action-button"
            value="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessAnalytics/ExportExcel')}">
            <p:dataExporter type="csv" target="node" fileName="#{processesAnalyticsBean.generateNameOfExcelFile()}" />
          </p:commandButton>
        </h:panelGroup>
      </h:form>
      <script>
        function addCustomTextForEmptyDropdown() {
          if ($('[id$="custom-field-name_panel"]').find('li').length == 0) {
            $('[id$="custom-field-name_panel"]').html('<div class="empty-checkbox text-center p-2">#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/NoCustomFieldsAvailable')}</div>');
          } else {
            $('[id$="custom-field-name_panel"]').find('.empty-checkbox').remove();
          }
        };
        addCustomTextForEmptyDropdown;
        setInterval(addCustomTextForEmptyDropdown, 500);
      </script>
    </ui:define>
  </ui:composition>
</h:body>
</html>
