<html xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:cc="http://xmlns.jcp.org/jsf/composite" xmlns:ic="http://ivyteam.ch/jsf/component"
  xmlns:p="http://primefaces.org/ui" xmlns:pe="http://primefaces.org/ui/extensions"
  xmlns:c="http://java.sun.com/jsp/jstl/core">
<cc:interface componentType="IvyComponent">
  <cc:attribute name="componentToUpdate" default="@this"/>
  <cc:attribute name="rendered" default="true"/>
  <cc:attribute name="managedBean" />
  <cc:attribute name="kpiType" />
  
</cc:interface>

<cc:implementation>
  <c:set var="kpiType" value="#{cc.attrs.kpiType}" />
  <c:set var="isWidgetMode" value="#{cc.attrs.managedBean.isWidgetMode}" />
  <c:set var="managedBean" value="#{cc.attrs.managedBean}" />
  <c:set var="rendered" value="#{cc.attrs.rendered}"/>
  <c:set var="persistedConfig" value="#{cc.attrs.managedBean.persistedConfig}"/>
  <c:set var="isFrequecyKpi" value="#{kpiType eq 'FREQUENCY'}"/>
  <f:event listener="#{colorPickerBean.initBean(kpiType, isWidgetMode)}" type="preRenderComponent"/>
  <h:panelGroup id="color-container" layout="block" styleClass="color-container" rendered="#{rendered}">
    <p:outputPanel id="color-bar-segment">
      <h:panelGroup layout="block" styleClass="duration-container"
        rendered="#{kpiType ne null}">
        <h:panelGroup styleClass="duration-labels">
          <h:outputText styleClass="duration-label left"
            value="#{ivy.cms.co(isFrequecyKpi ? '/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/LowExecution' : '/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/LowDuration')}"
            escape="false" />
          <h:outputText styleClass="duration-label right"
            value="#{ivy.cms.co(isFrequecyKpi ? '/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/HighExecution' : '/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/HighDuration')}"
            escape="false" />
        </h:panelGroup>
        <div class="duration-bar">
          <ui:repeat value="#{colorPickerBean.colorSegments}" var="color" varStatus="status">
            <p:commandLink actionListener="#{colorPickerBean.onSegmentClick}"
              update="#{cc.clientId}:color-picker-panel" styleClass="segment"
              style="background-color: #{color};"
              oncomplete="PF('colorPickerWidget').show();"
              ondblclick="return false;"
              process="@this" partialSubmit="true"
              rendered="#{colorPickerBean.selectedColorMode == 'CUSTOM'}">
              <f:attribute name="segmentIndex" value="#{status.index}" />
            </p:commandLink>
            <h:outputText styleClass="segment"
                  style="background-color: #{color};"
                  rendered="#{colorPickerBean.selectedColorMode == 'HEATMAP'}" />
          </ui:repeat>
        </div>
      </h:panelGroup>
    </p:outputPanel>

    <p:outputPanel id="color-picker-panel" styleClass="color-picker-panel">
      <div id="color-picker-wrapper">
        <p:colorPicker id="color-picker" mode="inline"
          value="#{colorPickerBean.selectedColor}"
          rendered="#{colorPickerBean.checkRenderCondition()}"
          widgetVar="colorPickerWidget" theme="large" format="rgb"
          alpha="false">
          <p:ajax event="change"
            listener="#{colorPickerBean.onColorChange}"
            update="color-bar-segment" process="@this"
            partialSubmit="true" delay="500" global="false"
            onsuccess="$('.color-picker-panel').hide();" />
        </p:colorPicker>
      </div>
    </p:outputPanel>
    <h:panelGroup layout="block" rendered="#{rendered and kpiType ne null}"
      styleClass="flex align-items-center gap-2 justify-content-center">
      <p:outputLabel for="colorModeDropdown" styleClass="pb-2 w-6rem"
        value="#{ivy.cms.co('/Dialogs/com/axonivy/solutions/process/analyser/ProcessesMonitor/PleaseSelectColorMode')}" />
      <p:selectOneMenu id="colorModeDropdown"
        value="#{colorPickerBean.selectedColorMode}"
        styleClass="color-mode-dropdown w-8rem">
        <f:selectItems value="#{colorPickerBean.colorModes}"
          var="colorMode" itemValue="#{colorMode}"
          itemLabel="#{colorMode.cmsName}" />
        <p:ajax event="change"
          listener="#{managedBean.onColorModeChange()}"
          process="@this"
          update="color-bar-segment"
          partialSubmit="true" />
      </p:selectOneMenu>
    </h:panelGroup>
  </h:panelGroup>
</cc:implementation>
</html>
